---
layout: post
title:  "PoW VS.PoS - 聊聊共识"
date:   2022-12-11 16:43:15 +0800
categories: blockchain
---

# PoW VS.PoS - 聊聊共识

9月初，以太坊合并升级成功，共识机制从与比特币相同的PoW转向PoS，即proof of work(工作量证明)和proof of stake(权益证明)。以前，矿工们拼命做数学题竞争记账权。今日，你有32个ETH，就能随机获得记账权。

这可动了矿工的蛋糕，他们不高兴了，于是有了ETHW和ETHF分叉，给议论已纷纷的合并又点多了一把火。

矿工是维护区块链网络的大力量，以太坊不顾他们的利益坚持转向PoS，主要还是解决两大问题：能耗和中心化。挖矿的费电自不必说，而矿场的日益中心化，确实让社区担忧，也确实损害了社区利益。今天，就来聊聊内里详情。

## 挥汗解题的PoW矿工图了什么

看完[本系列首篇](pengbo.club/blockchain/%E4%B8%80%E6%96%87%E7%B2%BE%E9%80%9A%E6%AF%94%E7%89%B9%E5%B8%81-%E5%85%A8%E7%BD%91%E6%9C%80%E7%89%9B)你已了解什么是PoW。我们再重现一下挖矿的细节，且看下图。

![PoW](/assets/PoW_demo.png)

当一笔BTC交易发起后，在整个比特币P2P网络中传播，与此同时，网络中的矿工节点拼命解题，不停尝试新的nounce以得出符合要求的哈希值。最终，第一个成功解题的矿工出现了，它获得记账权，把题目答案+交易打包到自己构建的区块里，向全网络广播，验证通过后，循环以上步骤。这就是矿工的轮回。

矿工挥汗如雨地解题，以将比特币和交易手续费收入囊中。而随着厉害的矿工不断加大投入，垄断趋势开始出现，永远都是那么三五个大矿场在轮流获取记账权。这种中心化趋势，让整个区块链网络变得脆弱，理论上只要有两三个矿产联合，就足以发起共识攻击。

此外，记账权的集中还导致腐败问题。和矿场关系好的人，或者只要给矿场一定小费，就能让自己的交易获得优先记账，从而损害了其他用户的利益。

再加上严重的能耗问题，以太坊便开始了PoS转向。

## 去中心化解题

区块链社区里有不同版本的PoS，这里只谈以太坊的版本。

在一笔交易发起后，现在节点不需要解题了，你只要有32枚ETH，就能随机获得记账权。然而从交易发起，到最终记账之前，仿若进入了黑森林，暗流涌动，杀机起伏，一众英才为了记账利益巧取豪夺，殊不知，他们始终只是去中心化大局下的棋子而已。且看下图。

![PoS](/assets/PoS_demo.png)


交易发起被广播到以太坊网络以后，首先会有所谓的MEV searcher去分析每一笔交易，伺机套利。MEV(maximum extracted value)，即最大可攫取利益，是指从交易中可以获得的显性和隐性的利益。显性利益就是指显而易见如gas fee(不了解以太坊网络的可以读[本系列第二篇](http://pengbo.club/blockchain/关于以太坊，你所要知道的)），隐性利益则是指广义的套利。比如发现有人在uniswap以3000刀买一枚ETH，那么MEV searcher就可以1200买一枚，并且以3000与该用户抢先成交。

所以一名MEV searcher，它要扫描每一笔交易，真的读懂交易在干什么，再评估是否有套利机会。这在程序上不是一件易事，所以MEV searcher的形式常常是MEV bots，即自动执行代码的套利机器人。因为程序的复杂度，每一类bots都有其专注的套利场景，比如上述的DEX套利。

MEV searcher整理好交易以后，会将其打包成（叫做bundle），发送给下游叫做block builder的角色。block builder就是真正在生成区块的人，他们把网络上的独立交易，以及MEV searcher发来的bundle，取最大化利益的集合，打包在一个区块中。

最后block builder把打包好的区块发给block proposer，就是拿着32个ETH的staker，被某种算法选中的staker负责最终验证区块，然后全网广播。

以上可见记账过程中的暗流，将其串联起来发现，block proposer也就是staker，才是最终的收割机。为什么？

首先，MEV searcher虽然技术含量很高，但一旦发现套利机会，它要确保下游block builder能尽快将其bundle打包，实现套利。为此，它需要为bundle付出一笔可观的打包费，才能让block builder看上。不然，先机就被其他searcher抢占。

接着，block builder为了将兑现这个bundle的高价打包费，又要在打包的区块中，附上客观的费用，以让最终的block proposer优先验证它的区块。套利机会如此层层流转，最终block proposer，即ETH staker，也就是ETH网络的股东，获得了最大收益。所以，一开始说，所有厮杀的上游，都“只是去中心化大局下的棋子而已”。

## 后PoS时代

随着业务对区块链性能的要求越来越高，要成为矿工，不管是PoS还是PoW，难度越来越大，因为需要性能更高、价格更贵的硬件，这很难不导致中心化。

既然区块验证的中心化趋势不可避免，而PoS的转向又是为了减少中心化、减少矿工为了私利而审查交易，那么以太坊便对PoS机制加以分层，引入更细致的分工和抗审查机制，让社区大众成为最终受益者。



